"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[900],{66651:function(e,a,t){t.d(a,{z:function(){return i}});var o=t(57437),n=t(86264),r=t(22169);function i(e){let{children:a,className:t,variant:i="primary",size:c="md",isLoading:s=!1,leftIcon:l,rightIcon:d,disabled:u,...f}=e;return(0,o.jsxs)("button",{className:(0,r.cn)("btn",{primary:"btn-primary",secondary:"btn-secondary",danger:"btn-danger",success:"btn-success",ghost:"btn-ghost"}[i],{sm:"px-3 py-1.5 text-xs",md:"px-4 py-2.5 text-sm",lg:"px-6 py-3 text-base"}[c],t),disabled:u||s,...f,children:[s?(0,o.jsx)(n.Z,{className:"w-4 h-4 animate-spin"}):l,a,!s&&d]})}},548:function(e,a,t){t.d(a,{Ct:function(){return s},TK:function(){return c},ub:function(){return i}});var o=t(57437),n=t(22169),r=t(92851);function i(e){let{icon:a,title:t,description:n,action:i}=e;return(0,o.jsxs)("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[(0,o.jsx)("div",{className:"w-20 h-20 rounded-2xl bg-dark-800 flex items-center justify-center mb-6",children:a||(0,o.jsx)(r.Z,{className:"w-10 h-10 text-dark-500"})}),(0,o.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:t}),n&&(0,o.jsx)("p",{className:"text-dark-400 max-w-sm mb-6",children:n}),i]})}function c(e){let{size:a="md"}=e;return(0,o.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,o.jsx)("div",{className:(0,n.cn)("rounded-full border-dark-700 border-t-primary-500 animate-spin",{sm:"w-6 h-6 border-2",md:"w-10 h-10 border-3",lg:"w-16 h-16 border-4"}[a])})})}function s(e){let{children:a,variant:t="success",size:r="md",className:i}=e;return(0,o.jsx)("span",{className:(0,n.cn)("badge",{success:"badge-success",danger:"badge-danger",warning:"badge-warning",info:"badge-info",primary:"badge-info",secondary:"bg-dark-600 text-dark-300"}[t],{sm:"text-xs px-1.5 py-0.5",md:"text-xs px-2 py-1",lg:"text-sm px-3 py-1.5"}[r],i),children:a})}},87431:function(e,a,t){t.d(a,{$_:function(){return z},$m:function(){return ef},$n:function(){return ex},A6:function(){return eI},A_:function(){return L},BR:function(){return G},Bj:function(){return d},C3:function(){return y},CF:function(){return e_},Cd:function(){return ew},Df:function(){return E},Dr:function(){return el},E8:function(){return h},FH:function(){return i},Fd:function(){return eN},Fp:function(){return x},GZ:function(){return q},G_:function(){return eO},H1:function(){return ey},H3:function(){return S},Hq:function(){return ez},J4:function(){return ei},Js:function(){return _},LK:function(){return p},LT:function(){return T},Me:function(){return w},NV:function(){return eg},O0:function(){return k},OI:function(){return eM},OQ:function(){return r},Ol:function(){return I},Ow:function(){return v},QV:function(){return D},RS:function(){return V},SJ:function(){return U},T6:function(){return en},TL:function(){return es},TM:function(){return F},UO:function(){return eL},UP:function(){return B},Uu:function(){return eu},V3:function(){return m},W4:function(){return H},Wr:function(){return j},Xh:function(){return u},Y8:function(){return eE},YB:function(){return Y},Yz:function(){return eS},Z2:function(){return l},ZF:function(){return P},ZH:function(){return $},_S:function(){return eb},aP:function(){return eD},as:function(){return Q},e6:function(){return Z},eB:function(){return R},eR:function(){return C},fz:function(){return K},gI:function(){return J},gO:function(){return O},gy:function(){return er},hD:function(){return eA},i1:function(){return X},j:function(){return eo},j7:function(){return em},je:function(){return A},jk:function(){return W},k3:function(){return eR},lM:function(){return N},q7:function(){return c},r2:function(){return ej},rO:function(){return ep},rZ:function(){return s},sE:function(){return eq},sL:function(){return M},te:function(){return ev},wQ:function(){return ec},yV:function(){return b},yY:function(){return eh},zI:function(){return eT},zb:function(){return g}});var o=t(69073),n=t(22169);let r=(0,o.eI)("https://yhiiupamxdjmnrktkjku.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InloaWl1cGFteGRqbW5ya3Rramt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODg2NzUsImV4cCI6MjA4NDA2NDY3NX0._QjYtYAlypJdursHe0-rPz14QOT4NNP2EklqcJ6TpkI");async function i(){let{data:e,error:a}=await r.from("categorias").select("*").order("nome");if(a)throw a;return e||[]}async function c(e){let{data:a,error:t}=await r.from("categorias").insert([e]).select().single();if(t)throw Error(t.message);return a}async function s(e,a){let{data:t,error:o}=await r.from("categorias").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function l(e){let{error:a}=await r.from("categorias").delete().eq("id",e);if(a)throw Error(a.message)}async function d(){let{data:e,error:a}=await r.from("classificacoes_fiscais").select("*").order("codigo");if(a)throw a;return e||[]}async function u(){let{data:e,error:a}=await r.from("produtos").select("\n      *,\n      categoria:categorias(*),\n      fornecedor:fornecedores(*)\n    ").order("nome");if(a)throw a;return e||[]}function f(e){return Math.round(100*e)/100}async function m(e){if(e.descricao&&e.descricao.trim()){let{data:a}=await r.from("produtos").select("*").ilike("nome",e.descricao.trim()).limit(1).single();if(a)return console.log("[findProdutoExistente] Encontrado por nome exato:",a.nome),a}return console.log("[findProdutoExistente] Produto n\xe3o encontrado:",e.descricao),null}async function _(e,a,t){let o=await m(e),i=f(e.valorUnitario);if(o){let t={valor_custo:i,custo_ultima_compra:i,custo_medio:i};if(e.codigo&&!o.codigo&&(t.codigo=e.codigo),a){let e=f(i*(1+(o.margem_lucro||0)/100));t.valor_venda=e}console.log("[upsertProdutoPorImportacao] Atualizando produto:",{id:o.id,nome:o.nome,custoAnterior:o.valor_custo,novoCusto:i,margemExistente:o.margem_lucro,novoPrecoVenda:t.valor_venda,atualizarVenda:a});let{data:n,error:c}=await r.from("produtos").update({...t,updated_at:new Date().toISOString()}).eq("id",o.id).select().single();if(c)throw Error("Erro ao atualizar produto: ".concat(c.message));return{produtoId:o.id,acao:"atualizado",produto:n}}{let a={codigo:e.codigo||null,nome:e.descricao,ncm:e.ncm||null,cfop:e.cfop||null,unidade:(0,n.zm)(e.unidade),valor_custo:i,valor_venda:i,custo_medio:i,custo_ultima_compra:i,margem_lucro:0,quantidade_estoque:0,fornecedor_id:t,classificacao_fiscal:"07",ativo:!0};e.gtin&&e.gtin.length>3&&!/^0+$/.test(e.gtin)&&(a.gtin_ean=e.gtin,a.codigo_barras=e.gtin),console.log("[upsertProdutoPorImportacao] Criando novo produto:",a);let{data:o,error:c}=await r.from("produtos").insert([a]).select().single();if(c)throw Error("Erro ao criar produto: ".concat(c.message));return{produtoId:o.id,acao:"criado",produto:o}}}async function g(e,a){let t=r.from("produtos").select("id").ilike("nome",e);a&&(t=t.neq("id",a));let{data:o}=await t;return((null==o?void 0:o.length)||0)>0}async function p(e){if(e.nome&&await g(e.nome))throw Error("J\xe1 existe um produto com este nome");let a={...e,unidade:(0,n.zm)(e.unidade)},{data:t,error:o}=await r.from("produtos").insert([a]).select().single();if(o)throw Error(o.message);return t}async function w(e,a){if(a.nome&&await g(a.nome,e))throw Error("J\xe1 existe um produto com este nome");let t=a.unidade?{...a,unidade:(0,n.zm)(a.unidade)}:a,{data:o,error:i}=await r.from("produtos").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(i)throw Error(i.message);return o}async function v(e){let{data:a}=await r.from("movimentacoes_estoque").select("id").eq("produto_id",e).limit(1);a&&a.length>0&&await r.from("movimentacoes_estoque").delete().eq("produto_id",e);let{error:t}=await r.from("produtos").delete().eq("id",e);if(t)throw Error(t.message)}async function h(e){let a=r.from("movimentacoes_estoque").select("\n      *,\n      produto:produtos(id, nome, codigo)\n    ").order("data_movimentacao",{ascending:!1});e&&(a=a.eq("produto_id",e));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function D(e){let{data:a,error:t}=await r.from("movimentacoes_estoque").insert([e]).select().single();if(t)throw Error(t.message);return a}async function E(){let{data:e,error:a}=await r.from("fornecedores").select("*").order("razao_social");if(a)throw a;return e||[]}async function q(e){let a=e.replace(/\D/g,""),{data:t,error:o}=await r.from("fornecedores").select("*").eq("cnpj",a).single();return o?null:t}async function I(e){let a=e.replace(/\D/g,""),{data:t,error:o}=await r.from("fornecedores").select("*").eq("cpf",a).single();return o?null:t}async function O(e){e.cnpj&&(e.cnpj=e.cnpj.replace(/\D/g,""));let{data:a,error:t}=await r.from("fornecedores").insert([e]).select().single();if(t)throw Error(t.message);return a}async function S(e){let a=r.from("clientes").select("*");e&&("cliente"===e?a=a.in("tipo_cadastro",["cliente","ambos"]):"fornecedor"===e&&(a=a.in("tipo_cadastro",["fornecedor","ambos"])));let{data:t,error:o}=await a.order("nome");if(o)throw o;return t||[]}async function x(e){e.cnpj&&(e.cnpj=e.cnpj.replace(/\D/g,"")),e.cpf&&(e.cpf=e.cpf.replace(/\D/g,""));let{data:a,error:t}=await r.from("clientes").insert([e]).select().single();if(t)throw Error(t.message);return a}async function y(e,a){a.cnpj&&(a.cnpj=a.cnpj.replace(/\D/g,"")),a.cpf&&(a.cpf=a.cpf.replace(/\D/g,""));let{data:t,error:o}=await r.from("clientes").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function b(e){await r.from("enderecos_cliente").delete().eq("cliente_id",e);let{error:a}=await r.from("clientes").delete().eq("id",e);if(a)throw Error(a.message)}async function C(e){let{data:a,error:t}=await r.from("enderecos_cliente").select("*").eq("cliente_id",e).order("principal",{ascending:!1});if(t)throw t;return a||[]}async function A(e){let{data:a,error:t}=await r.from("enderecos_cliente").insert([e]).select().single();if(t)throw Error(t.message);return a}async function N(e,a){let{data:t,error:o}=await r.from("enderecos_cliente").update(a).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function L(e){let{error:a}=await r.from("enderecos_cliente").delete().eq("id",e);if(a)throw Error(a.message)}async function T(e){let a=e.replace(/\D/g,"");try{let e=await fetch("https://brasilapi.com.br/api/cnpj/v1/".concat(a));if(!e.ok)throw Error("CNPJ n\xe3o encontrado");return await e.json()}catch(e){throw Error("Erro ao consultar CNPJ")}}async function F(){let{data:e,error:a}=await r.from("notas_fiscais_entrada").select("\n      *,\n      fornecedor:fornecedores(*)\n    ").order("data_entrada",{ascending:!1});if(a)throw a;return e||[]}async function M(){let{data:e,error:a}=await r.from("notas_fiscais").select("\n      *,\n      venda:vendas!notas_fiscais_venda_id_fkey(\n        id,\n        numero,\n        data_venda,\n        valor_total,\n        cliente:clientes(id, nome, razao_social, cnpj, cpf)\n      )\n    ").order("created_at",{ascending:!1});if(a)throw a;return(e||[]).map(e=>{var a;return{...e,cliente:(null===(a=e.venda)||void 0===a?void 0:a.cliente)||null}})}async function R(e){let{data:a,error:t}=await r.from("notas_fiscais_entrada").select("*").eq("chave_acesso",e).single();return t?null:a}async function j(e){let{data:a,error:t}=await r.from("itens_nota_entrada").insert([e]).select().single();if(t)throw Error(t.message);return a}async function z(e){let{data:a,error:t}=await r.from("itens_nota_entrada").select("\n      *,\n      produto:produtos!itens_nota_entrada_produto_id_fkey(id, nome, codigo)\n    ").eq("nota_fiscal_id",e);if(t)throw t;return a||[]}async function U(e){let a=r.from("categorias_financeiras").select("*").order("nome");e&&(a=a.eq("tipo",e));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function P(e){let{data:a,error:t}=await r.from("categorias_financeiras").insert([e]).select().single();if(t)throw Error(t.message);return a}async function k(e,a){let{data:t,error:o}=await r.from("categorias_financeiras").update(a).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function G(e){let{data:a}=await r.from("lancamentos_financeiros").select("id").eq("categoria_id",e).limit(1);if(a&&a.length>0)return{success:!1,message:"Esta categoria est\xe1 sendo usada em lan\xe7amentos financeiros e n\xe3o pode ser exclu\xedda."};let{data:t}=await r.from("contas_pagar").select("id").eq("categoria_id",e).limit(1);if(t&&t.length>0)return{success:!1,message:"Esta categoria est\xe1 sendo usada em contas a pagar e n\xe3o pode ser exclu\xedda."};try{let{data:a}=await r.from("contas_receber").select("id").eq("categoria_id",e).limit(1);if(a&&a.length>0)return{success:!1,message:"Esta categoria est\xe1 sendo usada em contas a receber e n\xe3o pode ser exclu\xedda."}}catch(e){}let{error:o}=await r.from("categorias_financeiras").delete().eq("id",e);return o?{success:!1,message:"Erro ao excluir: ".concat(o.message)}:{success:!0,message:"Categoria exclu\xedda com sucesso."}}async function X(){let{data:e,error:a}=await r.from("contas_bancarias").select("*").order("nome");if(a)throw a;return e||[]}async function B(e){let{data:a,error:t}=await r.from("contas_bancarias").insert([e]).select().single();if(t)throw Error(t.message);return a}async function J(e,a){let{data:t,error:o}=await r.from("contas_bancarias").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function Z(e){let a=r.from("lancamentos_financeiros").select("\n      *,\n      categoria:categorias_financeiras(*),\n      conta:contas_bancarias(*),\n      cliente:clientes(*),\n      fornecedor:fornecedores(*)\n    ").order("data_lancamento",{ascending:!1});(null==e?void 0:e.dataInicio)&&(a=a.gte("data_lancamento",e.dataInicio)),(null==e?void 0:e.dataFim)&&(a=a.lte("data_lancamento",e.dataFim)),(null==e?void 0:e.tipo)&&(a=a.eq("tipo",e.tipo)),(null==e?void 0:e.contaId)&&(a=a.eq("conta_id",e.contaId)),(null==e?void 0:e.categoriaId)&&(a=a.eq("categoria_id",e.categoriaId));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function $(e){let{data:a,error:t}=await r.from("lancamentos_financeiros").insert([e]).select().single();if(t)throw Error(t.message);return a}async function V(e,a){let{data:t,error:o}=await r.from("lancamentos_financeiros").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function Q(e){let{error:a}=await r.from("lancamentos_financeiros").delete().eq("id",e);if(a)throw Error(a.message)}async function H(e){let{data:a,error:t}=await r.from("lancamentos_financeiros").select("*").eq("id",e).single();if(t||!a)return{canDelete:!1,reason:"Lan\xe7amento n\xe3o encontrado"};if(console.log("[verificarExclusaoLancamento] ID:",e),console.log("[verificarExclusaoLancamento] venda_id:",a.venda_id,typeof a.venda_id),console.log("[verificarExclusaoLancamento] nota_fiscal_entrada_id:",a.nota_fiscal_entrada_id,typeof a.nota_fiscal_entrada_id),console.log("[verificarExclusaoLancamento] conciliado:",a.conciliado),a.conciliado)return{canDelete:!1,reason:"Lan\xe7amento j\xe1 est\xe1 conciliado. Desfa\xe7a a concilia\xe7\xe3o antes de excluir."};let o=a.venda_id&&0!==a.venda_id&&"0"!==a.venda_id&&"null"!==a.venda_id?a.venda_id:null,n=a.nota_fiscal_entrada_id&&0!==a.nota_fiscal_entrada_id&&"0"!==a.nota_fiscal_entrada_id&&"null"!==a.nota_fiscal_entrada_id?a.nota_fiscal_entrada_id:null;if(console.log("[verificarExclusaoLancamento] vendaId normalizado:",o),console.log("[verificarExclusaoLancamento] notaFiscalEntradaId normalizado:",n),o){let{data:e}=await r.from("vendas").select("id").eq("id",o).single();if(console.log("[verificarExclusaoLancamento] Venda encontrada:",e),e)return{canDelete:!1,reason:"Lan\xe7amento vinculado a uma venda. Exclua a venda primeiro."};console.log("[verificarExclusaoLancamento] V\xednculo \xf3rf\xe3o de venda_id detectado, permitindo exclus\xe3o")}if(n){let{data:e}=await r.from("notas_fiscais_entrada").select("id").eq("id",n).single();if(console.log("[verificarExclusaoLancamento] NF Entrada encontrada:",e),e)return{canDelete:!1,reason:"Lan\xe7amento vinculado a uma NF de entrada. Exclua a NF primeiro."};console.log("[verificarExclusaoLancamento] V\xednculo \xf3rf\xe3o de nota_fiscal_entrada_id detectado, permitindo exclus\xe3o")}return{canDelete:!0}}async function K(e){try{let{data:a,error:t}=await r.from("notas_fiscais_entrada").select("*").eq("id",e).single();if(t||!a)return{success:!1,message:"Nota fiscal n\xe3o encontrada"};let{data:o}=await r.from("movimentacoes_estoque").select("id, produto_id, quantidade, tipo").eq("nota_fiscal_id",e);if(o&&o.length>0){for(let e of o)if("entrada"===e.tipo){let{data:a}=await r.from("produtos").select("quantidade_estoque").eq("id",e.produto_id).single();a&&await r.from("produtos").update({quantidade_estoque:Math.max(0,a.quantidade_estoque-e.quantidade)}).eq("id",e.produto_id)}let{error:a}=await r.from("movimentacoes_estoque").delete().eq("nota_fiscal_id",e);a&&console.error("Erro ao deletar movimenta\xe7\xf5es:",a)}let{error:n}=await r.from("lancamentos_financeiros").delete().eq("nota_fiscal_entrada_id",e);n&&console.error("Erro ao deletar lan\xe7amentos:",n);let{error:i}=await r.from("contas_pagar").delete().eq("nota_fiscal_id",e);i&&console.error("Erro ao deletar contas a pagar:",i);let{error:c}=await r.from("itens_nota_entrada").delete().eq("nota_fiscal_id",e);c&&console.error("Erro ao deletar itens da nota:",c);let{error:s}=await r.from("notas_fiscais_entrada").delete().eq("id",e);if(s)return{success:!1,message:"Erro ao excluir nota fiscal: "+s.message};return{success:!0,message:"Nota fiscal exclu\xedda com sucesso. Removidos: ".concat((null==o?void 0:o.length)||0," movimenta\xe7\xf5es de estoque.")}}catch(e){return console.error("Erro na exclus\xe3o cascata:",e),{success:!1,message:"Erro ao processar exclus\xe3o: "+(e instanceof Error?e.message:"Erro desconhecido")}}}async function Y(e){try{let{data:a,error:t}=await r.from("notas_fiscais").select("*").eq("id",e).single();if(t||!a)return{success:!1,message:"Nota fiscal n\xe3o encontrada"};if("autorizado"===a.status||"autorizada"===a.status)return{success:!1,message:"N\xe3o \xe9 poss\xedvel excluir uma nota fiscal j\xe1 autorizada pela SEFAZ. Use a op\xe7\xe3o de cancelamento."};await r.from("notas_fiscais_eventos").delete().eq("nota_fiscal_id",e),await r.from("lancamentos_financeiros").delete().eq("nota_fiscal_saida_id",e),a.venda_id&&await r.from("vendas").update({nota_fiscal_emitida:!1,numero_nf:null,chave_nf:null,nota_fiscal_status:null,nota_fiscal_id:null}).eq("id",a.venda_id);let{error:o}=await r.from("notas_fiscais").delete().eq("id",e);if(o)return{success:!1,message:"Erro ao excluir nota fiscal: "+o.message};return{success:!0,message:"Nota fiscal de sa\xedda exclu\xedda com sucesso."}}catch(e){return console.error("Erro na exclus\xe3o de NF sa\xedda:",e),{success:!1,message:"Erro ao processar exclus\xe3o: "+(e instanceof Error?e.message:"Erro desconhecido")}}}async function W(e,a){let t=e.replace(/[<>\/]/g,"").trim(),o=r.from("lancamentos_financeiros").select("id").eq("ofx_fitid",t);a&&(o=o.eq("conta_id",a));let{data:n}=await o;return((null==n?void 0:n.length)||0)>0}function ee(e){return e?e.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([a-zA-Z])(\d)/g,"$1 $2").replace(/(\d)([a-zA-Z])/g,"$1 $2").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[.,;:!?@#$%&*()[\]{}<>\/\\|`~^"'=-]/g," ").replace(/\b(compras|nacionais|internacionais|pix|ted|doc|parcela|ref|nr|num|numero|pagamento|debito|credito|liquidacao|boleto|tarifa)\b/gi,"").replace(/\b[a-z]{1,3}\d{5,}\b/gi,"").replace(/\b(ltda|me|eireli|sa|epp|ss|s\/s)\b/gi,"").replace(/\b(sinop|cuiaba|brasilia|sao paulo|rio de janeiro|mt|sp|rj|mg|br|brasil)\b/gi,"").replace(/\s+/g," ").trim():""}function ea(e){let a=ee(e).split(" ").filter(e=>e.length>2);return new Set(a)}function et(e,a){if(0===e.size&&0===a.size||0===e.size||0===a.size)return 0;let t=Array.from(e),o=Array.from(a),n=new Set(t.filter(e=>a.has(e))),r=new Set([...t,...o]);return n.size/r.size}async function eo(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.3,{data_lancamento:o,valor:n,descricao:i}=e;if(!o||!n||!i||i.length<3)return[];let c=new Date(o),s=new Date(c);s.setDate(s.getDate()-3);let l=new Date(c);l.setDate(l.getDate()+3);try{let{data:e,error:o}=await r.from("lancamentos_financeiros").select("\n        id,\n        data_lancamento,\n        descricao,\n        valor,\n        tipo,\n        categoria_id,\n        conta_id,\n        categoria:categorias_financeiras(nome),\n        conta:contas_bancarias(nome)\n      ").gte("data_lancamento",s.toISOString().split("T")[0]).lte("data_lancamento",l.toISOString().split("T")[0]).gte("valor",n-.01).lte("valor",n+.01).limit(50);if(o)return console.error("Erro ao buscar lan\xe7amentos semelhantes:",o),[];if(!e||0===e.length)return[];let c=ea(i);return e.map(e=>{var a,t;let o=ea(e.descricao||""),n=et(c,o);return{id:e.id,data_lancamento:e.data_lancamento,descricao:e.descricao,valor:e.valor,tipo:e.tipo,categoria_id:e.categoria_id,conta_id:e.conta_id,categoria_nome:(null===(a=e.categoria)||void 0===a?void 0:a.nome)||void 0,conta_nome:(null===(t=e.conta)||void 0===t?void 0:t.nome)||void 0,score:n}}).filter(e=>e.score>=t).sort((e,a)=>a.score-e.score).slice(0,a)}catch(e){return console.error("Erro ao buscar lan\xe7amentos semelhantes:",e),[]}}async function en(e){let{fitid:a,contaId:t,data:o,valor:n,descricao:i}=e;if(a&&a.trim()){let e=a.replace(/[<>\/]/g,"").trim(),{data:o}=await r.from("lancamentos_financeiros").select("id").eq("ofx_fitid",e).eq("conta_id",t).limit(1);if(o&&o.length>0)return{duplicado:!0,metodo:"fitid",lancamentoExistenteId:o[0].id}}let c=new Date(o),s=new Date(c);s.setDate(s.getDate()-2);let l=new Date(c);l.setDate(l.getDate()+2);let{data:d}=await r.from("lancamentos_financeiros").select("id, descricao").eq("conta_id",t).gte("data_lancamento",s.toISOString().split("T")[0]).lte("data_lancamento",l.toISOString().split("T")[0]).gte("valor",Math.abs(n)-.01).lte("valor",Math.abs(n)+.01).limit(20);if(d&&d.length>0){let e=ea(i);for(let a of d)if(et(e,ea(a.descricao||""))>=.6)return{duplicado:!0,metodo:"valor_data_desc",lancamentoExistenteId:a.id}}return{duplicado:!1,metodo:"nenhum"}}async function er(e){let{data_nf:a,valor:t,descricao_xml:o,fornecedor_nome:n}=e;try{let e=new Date(a),i=new Date(e);i.setDate(i.getDate()-3);let c=new Date(e);c.setDate(c.getDate()+3);let{data:s,error:l}=await r.from("lancamentos_financeiros").select("\n        id,\n        data_lancamento,\n        descricao,\n        valor,\n        tipo,\n        categoria_id,\n        conta_id,\n        conciliado,\n        com_nota_fiscal,\n        nota_fiscal_entrada_id,\n        ofx_fitid\n      ").in("tipo",["despesa","saida"]).gte("data_lancamento",i.toISOString().split("T")[0]).lte("data_lancamento",c.toISOString().split("T")[0]).gte("valor",t-.01).lte("valor",t+.01).is("nota_fiscal_entrada_id",null).eq("com_nota_fiscal",!1).limit(20);if(l)return console.error("Erro ao buscar lan\xe7amentos para reconciliar:",l),{candidatos:[],melhorMatch:null};if(!s||0===s.length)return{candidatos:[],melhorMatch:null};let d=n?"".concat(o," ").concat(n):o,u=ea(d),f=s.map(a=>{let t=ea(a.descricao||""),o=et(u,t),n=new Date(a.data_lancamento),r=Math.abs(Math.round((n.getTime()-e.getTime())/864e5));return{id:a.id,data_lancamento:a.data_lancamento,descricao:a.descricao,valor:a.valor,tipo:a.tipo,categoria_id:a.categoria_id,conta_id:a.conta_id,conciliado:a.conciliado,com_nota_fiscal:a.com_nota_fiscal,nota_fiscal_entrada_id:a.nota_fiscal_entrada_id,ofx_fitid:a.ofx_fitid,score:o,diferencaDias:r}}).filter(e=>e.score>=.55).sort((e,a)=>a.score!==e.score?a.score-e.score:e.diferencaDias-a.diferencaDias),m=null;if(1===f.length)m=f[0];else if(f.length>1){let e=f[0],a=f[1];e.score>=.7&&e.score-a.score>=.1&&(m=e)}return{candidatos:f,melhorMatch:m}}catch(e){return console.error("Erro ao buscar lan\xe7amentos para reconciliar:",e),{candidatos:[],melhorMatch:null}}}async function ei(e){let{lancamento_id:a,nota_fiscal_entrada_id:t,numero_nf:o,fornecedor_nome:n,categoria_id:i,forma_pagamento:c}=e;try{let{data:e,error:s}=await r.from("lancamentos_financeiros").select("*").eq("id",a).single();if(s||!e)return{success:!1,error:"Lan\xe7amento n\xe3o encontrado: "+((null==s?void 0:s.message)||"ID inv\xe1lido")};let l=e.descricao||"",d="NF ".concat(o," - ").concat(n).concat(l?" | OFX: ".concat(l):""),u={com_nota_fiscal:!0,nota_fiscal_entrada_id:t,descricao:d,updated_at:new Date().toISOString()};if(i){if(e.categoria_id&&e.categoria_id!==i){let a=e.observacao||"";u.observacao="".concat(a).concat(a?" | ":"","Categoria anterior ID: ").concat(e.categoria_id)}u.categoria_id=i}c&&(u.forma_pagamento=c);let{data:f,error:m}=await r.from("lancamentos_financeiros").update(u).eq("id",a).select().single();if(m)return{success:!1,error:"Erro ao atualizar lan\xe7amento: "+m.message};return console.log("✓ Lan\xe7amento #".concat(a," reconciliado com NF ").concat(o)),{success:!0,lancamento:f}}catch(e){return console.error("Erro ao reconciliar lan\xe7amento com NF:",e),{success:!1,error:"Erro interno ao reconciliar"}}}async function ec(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50;try{let{data:a,error:t}=await r.from("lancamentos_financeiros").select("\n        *,\n        categoria:categorias_financeiras(id, nome, tipo),\n        conta:contas_bancarias(id, nome)\n      ").is("grupo_principal_id",null).order("data_lancamento",{ascending:!1}).limit(500);if(t||!a)return console.error("Erro ao buscar lan\xe7amentos:",t),[];let o=[],n=new Set;for(let e=0;e<a.length;e++){let t=a[e];if(!n.has(t.id))for(let r=e+1;r<a.length;r++){let e=a[r];if(n.has(e.id))continue;let i="entrada"===t.tipo||"receita"===t.tipo?"entrada":"saida",c="entrada"===e.tipo||"receita"===e.tipo?"entrada":"saida";if(i!==c||Math.abs(t.valor-e.valor)>.01)continue;let s=new Date(t.data_lancamento),l=new Date(e.data_lancamento),d=Math.abs(Math.round((s.getTime()-l.getTime())/864e5));if(d>5||t.grupo_id&&t.grupo_id===e.grupo_id)continue;let u=ea(t.descricao||""),f=ea(e.descricao||""),m=et(u,f),_=(t.descricao||"").trim().toLowerCase()===(e.descricao||"").trim().toLowerCase();if(m>=.3||_){let a=t,r=e;!t.com_nota_fiscal&&e.com_nota_fiscal&&(a=e,r=t),o.push({lancamentoComNF:a,lancamentoSemNF:r,score:_?1:m,diferencaDias:d}),n.add(e.id);break}}}return o.sort((e,a)=>a.score-e.score).slice(0,e)}catch(e){return console.error("Erro ao detectar duplicados:",e),[]}}async function es(e){let{lancamentoNFId:a,lancamentoOFXId:t,acao:o}=e;try{let{data:e,error:n}=await r.from("lancamentos_financeiros").select("*").in("id",[a,t]);if(n||!e||2!==e.length)return{success:!1,error:"Lan\xe7amentos n\xe3o encontrados"};let i=e.find(e=>e.id===a),c=e.find(e=>e.id===t);if("mesclar"===o){let e=i.descricao+(c.descricao?" | OFX: ".concat(c.descricao):""),o=[i.observacao||"",c.observacao?"Obs OFX: ".concat(c.observacao):"",c.ofx_fitid?"FITID: ".concat(c.ofx_fitid):"","Reconciliado em: ".concat(new Date().toLocaleDateString("pt-BR"))].filter(Boolean).join(" | "),{error:n}=await r.from("lancamentos_financeiros").update({descricao:e,observacao:o,ofx_fitid:c.ofx_fitid||i.ofx_fitid,conta_id:c.conta_id||i.conta_id,conciliado:!0,updated_at:new Date().toISOString()}).eq("id",a);if(n)return{success:!1,error:"Erro ao atualizar lan\xe7amento: "+n.message};let{error:s}=await r.from("lancamentos_financeiros").delete().eq("id",t);if(s)return{success:!1,error:"Erro ao deletar lan\xe7amento OFX: "+s.message};console.log("✓ Lan\xe7amentos mesclados: #".concat(a," (NF) + #").concat(t," (OFX) -> #").concat(a))}else{let e=ed();await r.from("lancamentos_financeiros").update({grupo_id:e,grupo_principal_id:null,updated_at:new Date().toISOString()}).eq("id",a),await r.from("lancamentos_financeiros").update({grupo_id:e,grupo_principal_id:a,updated_at:new Date().toISOString()}).eq("id",t),console.log("✓ Lan\xe7amentos agrupados: #".concat(a," (principal) + #").concat(t," (subordinado)"))}return{success:!0}}catch(e){return console.error("Erro ao mesclar duplicados:",e),{success:!1,error:"Erro interno ao mesclar"}}}async function el(){let e={mesclados:0,detalhes:[]};try{console.log("═══════════════════════════════════════════════════════════"),console.log("\uD83D\uDD0D INICIANDO RECONCILIA\xc7\xc3O AUTOM\xc1TICA DE DUPLICADOS"),console.log("═══════════════════════════════════════════════════════════");let{data:a,error:t}=await r.from("lancamentos_financeiros").select("id, descricao, valor, data_lancamento, categoria_id, conta_id, com_nota_fiscal, tipo").eq("com_nota_fiscal",!0).in("tipo",["despesa","saida"]).order("data_lancamento",{ascending:!1}).limit(100);if(console.log("\n\uD83D\uDCCB Lan\xe7amentos COM NF encontrados: ".concat((null==a?void 0:a.length)||0)),t)return console.error("❌ Erro ao buscar lan\xe7amentos COM NF:",t),e;if(!a||0===a.length)return console.log("⚠️ Nenhum lan\xe7amento COM NF encontrado"),e;console.log("\n--- LAN\xc7AMENTOS COM NF (despesas) ---"),a.forEach(e=>{console.log("  #".concat(e.id," | ").concat(e.data_lancamento," | R$ ").concat(e.valor,' | "').concat(e.descricao,'" | tipo: ').concat(e.tipo))});let{data:o,error:n}=await r.from("lancamentos_financeiros").select("id, descricao, valor, data_lancamento, categoria_id, conta_id, ofx_fitid, com_nota_fiscal, tipo").eq("com_nota_fiscal",!1).in("tipo",["despesa","saida"]).order("data_lancamento",{ascending:!1}).limit(300);if(console.log("\n\uD83D\uDCCB Lan\xe7amentos SEM NF encontrados: ".concat((null==o?void 0:o.length)||0)),n)return console.error("❌ Erro ao buscar lan\xe7amentos SEM NF:",n),e;if(!o||0===o.length)return console.log("⚠️ Nenhum lan\xe7amento SEM NF encontrado"),e;for(let t of(console.log("\n--- LAN\xc7AMENTOS SEM NF (provavelmente OFX) ---"),o.forEach(e=>{console.log("  #".concat(e.id," | ").concat(e.data_lancamento," | R$ ").concat(e.valor,' | "').concat(e.descricao,'" | tipo: ').concat(e.tipo))}),console.log("\n═══════════════════════════════════════════════════════════"),console.log("\uD83D\uDD0E AN\xc1LISE DE POSS\xcdVEIS DUPLICADOS"),console.log("═══════════════════════════════════════════════════════════"),a)){let a=new Date(t.data_lancamento),n=Math.round(100*t.valor),i=6902===n;if(i){console.log('\n\uD83C\uDFAF ANALISANDO NF TARGET: "'.concat(t.descricao,'" (R$ ').concat(t.valor,")"));let e=o.filter(e=>Math.round(100*e.valor)===n);console.log("   \uD83D\uDCCB OFX com MESMO VALOR (R$ ".concat(t.valor,"): ").concat(e.length," encontrados")),e.forEach((e,a)=>{console.log("      ".concat(a+1,". #").concat(e.id," | ").concat(e.data_lancamento,' | "').concat(e.descricao,'"'))})}for(let c of o){let s=Math.round(100*c.valor),l=i&&n===s;if(l&&(console.log("\n   \uD83D\uDCCA COMPARANDO COM CANDIDATO:"),console.log('      NF:  "'.concat(t.descricao,'" | R$ ').concat(t.valor," | Data: ").concat(t.data_lancamento)),console.log('      OFX: "'.concat(c.descricao,'" | R$ ').concat(c.valor," | Data: ").concat(c.data_lancamento))),n!==s)continue;l&&console.log("      ✅ VALOR IGUAL: R$ ".concat(t.valor));let d=new Date(c.data_lancamento),u=Math.abs(Math.round((a.getTime()-d.getTime())/864e5));if(l&&console.log("      \uD83D\uDCC5 Diferen\xe7a de dias: ".concat(u)),u>3){l&&console.log("      ❌ DATAS MUITO DISTANTES: ".concat(u," dias (limite: 3)"));continue}l&&console.log("      ✅ DATAS PR\xd3XIMAS: ".concat(u," dias"));let f=ee(t.descricao||""),m=ee(c.descricao||""),_=ea(t.descricao||""),g=ea(c.descricao||""),p=et(_,g);if(l&&(console.log("\n      \uD83D\uDD24 AN\xc1LISE DE TEXTO:"),console.log('         NF Original:    "'.concat(t.descricao,'"')),console.log('         NF Normalizada: "'.concat(f,'"')),console.log("         NF Tokens:      [".concat(Array.from(_).join(", "),"]")),console.log('         OFX Original:   "'.concat(c.descricao,'"')),console.log('         OFX Normalizada: "'.concat(m,'"')),console.log("         OFX Tokens:     [".concat(Array.from(g).join(", "),"]")),console.log("         SCORE JACCARD:  ".concat((100*p).toFixed(1),"% (m\xednimo: 25%)"))),p>=.25){console.log("\n✅ MATCH ENCONTRADO!"),console.log('   NF:  "'.concat(t.descricao,'"')),console.log('   OFX: "'.concat(c.descricao,'"')),console.log("   Score: ".concat((100*p).toFixed(0),"%"));let a=t.descricao+" | OFX: ".concat(c.descricao);await r.from("lancamentos_financeiros").update({descricao:a,conta_id:c.conta_id||t.conta_id,ofx_fitid:c.ofx_fitid,conciliado:!0,updated_at:new Date().toISOString()}).eq("id",t.id),await r.from("lancamentos_financeiros").delete().eq("id",c.id),e.mesclados++,e.detalhes.push({nfId:t.id,ofxId:c.id,descricaoNF:t.descricao,descricaoOFX:c.descricao});let n=o.findIndex(e=>e.id===c.id);n>-1&&o.splice(n,1);break}l&&(console.log("\n      ❌ SCORE INSUFICIENTE: ".concat((100*p).toFixed(1),"% < 25%")),console.log("         Motivo: Os tokens n\xe3o t\xeam interse\xe7\xe3o suficiente"))}}console.log("\n═══════════════════════════════════════════════════════════"),console.log("\uD83D\uDD0D FASE 2: DEDUPLICA\xc7\xc3O GEN\xc9RICA (TODOS OS TIPOS)"),console.log("═══════════════════════════════════════════════════════════");let{data:i,error:c}=await r.from("lancamentos_financeiros").select("id, descricao, valor, data_lancamento, categoria_id, conta_id, com_nota_fiscal, tipo, grupo_id, grupo_principal_id, ofx_fitid, created_at").is("grupo_principal_id",null).order("data_lancamento",{ascending:!1}).limit(500);if(!c&&i&&i.length>1){let a=new Set;for(let t=0;t<i.length;t++){let o=i[t];if(!a.has(o.id))for(let n=t+1;n<i.length;n++){let t=i[n];if(a.has(t.id))continue;let c="entrada"===o.tipo||"receita"===o.tipo?"entrada":"saida",s="entrada"===t.tipo||"receita"===t.tipo?"entrada":"saida";if(c!==s)continue;let l=Math.round(100*o.valor),d=Math.round(100*t.valor);if(l!==d)continue;let u=new Date(o.data_lancamento),f=new Date(t.data_lancamento);if(Math.abs(Math.round((u.getTime()-f.getTime())/864e5))>3)continue;let m=ea(o.descricao||""),_=ea(t.descricao||""),g=et(m,_),p=(o.descricao||"").trim().toLowerCase()===(t.descricao||"").trim().toLowerCase();if(g>=.5||p){console.log("\n✅ DUPLICADO GEN\xc9RICO ENCONTRADO!"),console.log("   A: #".concat(o.id," | ").concat(o.data_lancamento," | R$ ").concat(o.valor,' | "').concat(o.descricao,'"')),console.log("   B: #".concat(t.id," | ").concat(t.data_lancamento," | R$ ").concat(t.valor,' | "').concat(t.descricao,'"')),console.log("   Score: ".concat((100*g).toFixed(0),"% | Desc iguais: ").concat(p));let n=o,i=t;!o.com_nota_fiscal&&t.com_nota_fiscal?(n=t,i=o):o.com_nota_fiscal===t.com_nota_fiscal&&new Date(o.created_at)>new Date(t.created_at)&&(n=t,i=o);let c=n.descricao+(i.descricao&&i.descricao!==n.descricao?" | Dup: ".concat(i.descricao):"");await r.from("lancamentos_financeiros").update({descricao:c,conta_id:n.conta_id||i.conta_id,categoria_id:n.categoria_id||i.categoria_id,ofx_fitid:n.ofx_fitid||i.ofx_fitid,conciliado:!0,updated_at:new Date().toISOString()}).eq("id",n.id),await r.from("lancamentos_financeiros").delete().eq("id",i.id),a.add(i.id),e.mesclados++,e.detalhes.push({nfId:n.id,ofxId:i.id,descricaoNF:n.descricao,descricaoOFX:i.descricao}),console.log("   ✅ Mantido #".concat(n.id,", removido #").concat(i.id));break}}}}return console.log("\n═══════════════════════════════════════════════════════════"),e.mesclados>0?console.log("✅ RECONCILIA\xc7\xc3O CONCLU\xcdDA: ".concat(e.mesclados," par(es) mesclado(s)")):console.log("ℹ️ NENHUM DUPLICADO \xd3BVIO ENCONTRADO"),console.log("═══════════════════════════════════════════════════════════\n"),e}catch(a){return console.error("❌ Erro na reconcilia\xe7\xe3o autom\xe1tica:",a),e}}function ed(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let a=16*Math.random()|0;return("x"===e?a:3&a|8).toString(16)})}async function eu(e){let{principal_id:a,duplicado_id:t}=e;try{let{data:e,error:o}=await r.from("lancamentos_financeiros").select("id, com_nota_fiscal, created_at, grupo_id, grupo_principal_id").in("id",[a,t]);if(o||!e||2!==e.length)return{success:!1,error:"Erro ao buscar lan\xe7amentos: "+((null==o?void 0:o.message)||"Lan\xe7amentos n\xe3o encontrados")};let n=e.find(e=>e.id===a),i=e.find(e=>e.id===t);if(n.grupo_id&&n.grupo_id===i.grupo_id)return{success:!1,error:"Lan\xe7amentos j\xe1 pertencem ao mesmo grupo"};let c=n.grupo_id||i.grupo_id||ed(),s=n.com_nota_fiscal||i.com_nota_fiscal,{error:l}=await r.from("lancamentos_financeiros").update({grupo_id:c,grupo_principal_id:null,com_nota_fiscal:s}).eq("id",a);if(l)return{success:!1,error:"Erro ao atualizar lan\xe7amento principal: "+l.message};let{error:d}=await r.from("lancamentos_financeiros").update({grupo_id:c,grupo_principal_id:a,com_nota_fiscal:s}).eq("id",t);if(d)return{success:!1,error:"Erro ao atualizar lan\xe7amento duplicado: "+d.message};return i.grupo_id&&await r.from("lancamentos_financeiros").update({grupo_principal_id:a,grupo_id:c}).eq("grupo_principal_id",t),{success:!0,grupo_id:c}}catch(e){return console.error("Erro ao agrupar lan\xe7amentos:",e),{success:!1,error:"Erro interno ao agrupar lan\xe7amentos"}}}async function ef(e){try{let{data:a,error:t}=await r.from("lancamentos_financeiros").select("id, grupo_id, grupo_principal_id").eq("id",e).single();if(t||!a)return{success:!1,error:"Lan\xe7amento n\xe3o encontrado"};if(!a.grupo_id)return{success:!1,error:"Lan\xe7amento n\xe3o pertence a nenhum grupo"};if(!a.grupo_principal_id){let{data:a}=await r.from("lancamentos_financeiros").select("id, com_nota_fiscal, created_at").eq("grupo_principal_id",e).order("created_at",{ascending:!0});if(a&&a.length>0){let e=a[0];if(await r.from("lancamentos_financeiros").update({grupo_principal_id:null}).eq("id",e.id),a.length>1){let t=a.slice(1).map(e=>e.id);await r.from("lancamentos_financeiros").update({grupo_principal_id:e.id}).in("id",t)}}}let{error:o}=await r.from("lancamentos_financeiros").update({grupo_id:null,grupo_principal_id:null}).eq("id",e);if(o)return{success:!1,error:"Erro ao remover do grupo: "+o.message};return{success:!0}}catch(e){return console.error("Erro ao desagrupar lan\xe7amento:",e),{success:!1,error:"Erro interno ao desagrupar"}}}async function em(e){try{let a=r.from("lancamentos_financeiros").select("\n        *,\n        categoria:categorias_financeiras(id, nome, tipo),\n        conta:contas_bancarias(id, nome),\n        cliente:clientes(id, nome_fantasia, razao_social),\n        fornecedor:fornecedores(id, nome_fantasia, razao_social)\n      ").order("data_lancamento",{ascending:!1});(null==e?void 0:e.tipo)&&(a=a.eq("tipo",e.tipo)),(null==e?void 0:e.dataInicio)&&(a=a.gte("data_lancamento",e.dataInicio)),(null==e?void 0:e.dataFim)&&(a=a.lte("data_lancamento",e.dataFim)),(null==e?void 0:e.contaId)&&(a=a.eq("conta_id",e.contaId)),(null==e?void 0:e.categoriaId)&&(a=a.eq("categoria_id",e.categoriaId)),(null==e?void 0:e.incluirSubordinados)||(a=a.is("grupo_principal_id",null));let{data:t,error:o}=await a.limit(500);if(o)return console.error("Erro ao buscar lan\xe7amentos agrupados:",o),[];if(!t)return[];let n=[];for(let e of t){let a={...e,is_grupo_principal:e.grupo_id&&!e.grupo_principal_id,grupo_total_itens:1,grupo_possui_nf:e.com_nota_fiscal,itens_grupo:[]};if(a.is_grupo_principal){let{data:t}=await r.from("lancamentos_financeiros").select("\n            *,\n            categoria:categorias_financeiras(id, nome, tipo),\n            conta:contas_bancarias(id, nome)\n          ").eq("grupo_principal_id",e.id);t&&t.length>0&&(a.itens_grupo=t,a.grupo_total_itens=1+t.length,a.grupo_possui_nf=e.com_nota_fiscal||t.some(e=>e.com_nota_fiscal))}n.push(a)}let i=[],c=new Set;for(let e of n){if(c.has(e.id))continue;let a=(e.descricao||"").trim().toLowerCase(),t=Math.round(100*(e.valor||0)),o=new Date(e.data_lancamento),r="entrada"===e.tipo||"receita"===e.tipo?"entrada":"saida",s=[];for(let i of n){if(i.id===e.id||c.has(i.id))continue;let n=(i.descricao||"").trim().toLowerCase(),l=Math.round(100*(i.valor||0)),d=new Date(i.data_lancamento),u="entrada"===i.tipo||"receita"===i.tipo?"entrada":"saida";if(r!==u||t!==l||Math.abs(Math.round((o.getTime()-d.getTime())/864e5))>3)continue;let f=ea(e.descricao||""),m=ea(i.descricao||""),_=et(f,m);(a===n||_>=.5)&&(s.push(i),c.add(i.id))}s.length>0&&(e.is_grupo_principal=!0,e.grupo_total_itens=1+s.length,e.itens_grupo=[...e.itens_grupo||[],...s]),c.add(e.id),i.push(e)}return i}catch(e){return console.error("Erro ao buscar lan\xe7amentos agrupados:",e),[]}}async function e_(e){let a=r.from("contas_pagar").select("\n      *,\n      fornecedor:fornecedores(*),\n      categoria:categorias_financeiras(*)\n    ").order("data_vencimento",{ascending:!0});(null==e?void 0:e.status)&&(a=a.eq("status",e.status)),(null==e?void 0:e.dataInicio)&&(a=a.gte("data_vencimento",e.dataInicio)),(null==e?void 0:e.dataFim)&&(a=a.lte("data_vencimento",e.dataFim)),(null==e?void 0:e.fornecedorId)&&(a=a.eq("fornecedor_id",e.fornecedorId));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function eg(e){let{data:a,error:t}=await r.from("contas_pagar").insert([e]).select().single();if(t)throw Error(t.message);return a}async function ep(e,a){let{data:t,error:o}=await r.from("contas_pagar").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function ew(e){let a=r.from("contas_receber").select("\n      *,\n      cliente:clientes(*)\n    ").order("data_vencimento",{ascending:!0});(null==e?void 0:e.status)&&(a=a.eq("status",e.status)),(null==e?void 0:e.dataInicio)&&(a=a.gte("data_vencimento",e.dataInicio)),(null==e?void 0:e.dataFim)&&(a=a.lte("data_vencimento",e.dataFim)),(null==e?void 0:e.clienteId)&&(a=a.eq("cliente_id",e.clienteId));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function ev(e){let{data:a,error:t}=await r.from("contas_receber").insert([e]).select().single();if(t)throw Error(t.message);return a}async function eh(e,a){let{data:t,error:o}=await r.from("contas_receber").update({...a,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(o)throw Error(o.message);return t}async function eD(e){let{error:a}=await r.from("contas_pagar").delete().eq("id",e);if(a)throw Error(a.message)}async function eE(e){let{error:a}=await r.from("contas_receber").delete().eq("id",e);if(a)throw Error(a.message)}async function eq(e){let{data:a,error:t}=await r.from("contas_pagar").select("*").eq("id",e).single();if(t||!a)throw Error("Conta a pagar n\xe3o encontrada");if("pago"!==a.status)throw Error("Esta conta n\xe3o est\xe1 marcada como paga");let o=new Date;o.setHours(0,0,0,0);let n=new Date(a.data_vencimento+"T00:00:00"),{data:i,error:c}=await r.from("contas_pagar").update({status:n<o?"vencido":"pendente",data_pagamento:null,valor_pago:0,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(c)throw Error(c.message);if(a.conta_bancaria_id&&a.data_pagamento){let{data:e}=await r.from("lancamentos_financeiros").select("id").eq("conta_id",a.conta_bancaria_id).eq("tipo","despesa").eq("valor",a.valor).eq("descricao",a.descricao).eq("data_lancamento",a.data_pagamento);if(e&&e.length>0){let a=e[e.length-1];await r.from("lancamentos_financeiros").delete().eq("id",a.id)}}return i}async function eI(e){let{data:a,error:t}=await r.from("contas_receber").select("*").eq("id",e).single();if(t||!a)throw Error("Conta a receber n\xe3o encontrada");if("recebido"!==a.status)throw Error("Esta conta n\xe3o est\xe1 marcada como recebida");let o=new Date;o.setHours(0,0,0,0);let n=new Date(a.data_vencimento+"T00:00:00"),{data:i,error:c}=await r.from("contas_receber").update({status:n<o?"vencido":"pendente",data_recebimento:null,valor_recebido:0,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(c)throw Error(c.message);if(a.conta_bancaria_id&&a.data_recebimento){let{data:e}=await r.from("lancamentos_financeiros").select("id").eq("conta_id",a.conta_bancaria_id).eq("tipo","receita").eq("valor",a.valor).eq("descricao",a.descricao).eq("data_lancamento",a.data_recebimento);if(e&&e.length>0){let a=e[e.length-1];await r.from("lancamentos_financeiros").delete().eq("id",a.id)}}return i}async function eO(e,a){let t={totalContas:0,conciliadas:0,jaConciliadas:0,semCorrespondencia:0,detalhes:[]},o="pagar"===e?"data_pagamento":"data_recebimento",n=r.from("pagar"===e?"contas_pagar":"contas_receber").select("*").eq("status","pagar"===e?"pago":"recebido").not(o,"is",null);a&&(n=n.eq("conta_bancaria_id",a));let{data:i,error:c}=await n;if(c)throw Error(c.message);if(!i||0===i.length)return t;for(let a of(t.totalContas=i.length,i)){let n=a.conta_bancaria_id;if(!n){t.semCorrespondencia++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"sem_correspondencia"});continue}let i=new Date(a[o]+"T00:00:00"),c=new Date(i);c.setDate(c.getDate()-3);let s=new Date(i);s.setDate(s.getDate()+3);let{data:l}=await r.from("lancamentos_financeiros").select("*").eq("conta_id",n).eq("valor",a.valor).gte("data_lancamento",c.toISOString().split("T")[0]).lte("data_lancamento",s.toISOString().split("T")[0]).in("tipo","pagar"===e?["despesa","saida"]:["receita","entrada"]);if(!l||0===l.length){t.semCorrespondencia++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"sem_correspondencia"});continue}if(l.length>1){let e=l.filter(e=>e.ofx_fitid),o=l.filter(e=>!e.ofx_fitid);if(e.length>0&&o.length>0)for(let e of o)await r.from("lancamentos_financeiros").delete().eq("id",e.id);let n=e[0]||l[0];n.conciliado?(t.jaConciliadas++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"ja_conciliado",lancamentoId:n.id})):(await r.from("lancamentos_financeiros").update({conciliado:!0,updated_at:new Date().toISOString()}).eq("id",n.id),t.conciliadas++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"conciliado",lancamentoId:n.id}))}else{let e=l[0];e.conciliado?(t.jaConciliadas++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"ja_conciliado",lancamentoId:e.id})):(await r.from("lancamentos_financeiros").update({conciliado:!0,updated_at:new Date().toISOString()}).eq("id",e.id),t.conciliadas++,t.detalhes.push({descricao:a.descricao,valor:a.valor,status:"conciliado",lancamentoId:e.id}))}}return t}async function eS(e){let a=r.from("vendas").select("\n      *,\n      cliente:clientes(*),\n      itens:itens_venda(*)\n    ").order("data_venda",{ascending:!1});(null==e?void 0:e.dataInicio)&&(a=a.gte("data_venda",e.dataInicio)),(null==e?void 0:e.dataFim)&&(a=a.lte("data_venda",e.dataFim)),(null==e?void 0:e.clienteId)&&(a=a.eq("cliente_id",e.clienteId));let{data:t,error:o}=await a;if(o)throw o;return t||[]}async function ex(e,a){let{data:t,error:o}=await r.from("vendas").insert([e]).select().single();if(o)throw Error(o.message);if(a&&a.length>0){let e=a.map(e=>({...e,venda_id:t.id})),{error:o}=await r.from("itens_venda").insert(e);if(o)throw Error(o.message)}return t}async function ey(e,a,t){let{data:o,error:n}=await r.from("vendas").update(a).eq("id",e).select().single();if(n)throw Error(n.message);if(void 0!==t&&(await r.from("itens_venda").delete().eq("venda_id",e),t.length>0)){let a=t.map(a=>({...a,venda_id:e})),{error:o}=await r.from("itens_venda").insert(a);if(o)throw Error(o.message)}return o}async function eb(e){await r.from("itens_venda").delete().eq("venda_id",e);let{error:a}=await r.from("vendas").delete().eq("id",e);if(a)throw Error(a.message)}async function eC(e){let{data:a}=await r.from("movimentacoes_estoque").select("id").eq("venda_id",e).eq("tipo","saida").limit(1);return((null==a?void 0:a.length)||0)>0}async function eA(e,a){if(await eC(e))return{baixados:0,jaExistentes:a.length};let t=0;for(let o of a)if(o.produto_id)try{let{data:a,error:n}=await r.from("produtos").select("quantidade_estoque").eq("id",o.produto_id).single();if(n||!a)continue;let i=Math.max(0,(a.quantidade_estoque||0)-o.quantidade);await r.from("produtos").update({quantidade_estoque:i,updated_at:new Date().toISOString()}).eq("id",o.produto_id),await r.from("movimentacoes_estoque").insert([{produto_id:o.produto_id,tipo:"saida",quantidade:o.quantidade,motivo:"Venda #".concat(e),venda_id:e,data_movimentacao:new Date().toISOString()}]),t++}catch(e){console.error("Erro ao baixar estoque do produto ".concat(o.produto_id,":"),e)}return{baixados:t,jaExistentes:0}}async function eN(e,a){let{data:t,error:o}=await r.from("notas_fiscais_entrada").insert([e]).select().single();if(o)throw Error(o.message);if(a&&a.length>0){let e=a.map(e=>({...e,nota_fiscal_id:t.id})),{error:o}=await r.from("itens_nota_entrada").insert(e);if(o)throw Error(o.message)}return t}async function eL(){let{data:e,error:a}=await r.from("ordens_servico").select("\n      *,\n      cliente:clientes(id, nome, razao_social, tipo_pessoa)\n    ").order("numero",{ascending:!1});if(a)throw a;return e||[]}async function eT(e){let{data:a,error:t}=await r.from("ordens_servico").select("\n      *,\n      cliente:clientes(id, nome, razao_social, tipo_pessoa, cnpj, cpf, telefone, celular, email, endereco, numero, bairro, cidade, estado, cep),\n      servicos:os_servicos(*),\n      produtos:os_produtos(*)\n    ").eq("id",e).single();if(t)throw t;return a}async function eF(){var e;let{data:a,error:t}=await r.from("ordens_servico").select("numero").order("numero",{ascending:!1}).limit(1);if(t)throw t;return((null==a?void 0:null===(e=a[0])||void 0===e?void 0:e.numero)||0)+1}async function eM(e,a,t){let o=await eF(),n=a.reduce((e,a)=>e+(a.valor_total||0),0),i=t.reduce((e,a)=>e+(a.valor_total||0),0),c=a.reduce((e,a)=>e+(a.quantidade||0),0),s=t.reduce((e,a)=>e+(a.quantidade||0),0),l=n+i,d=e.desconto_percentual?e.desconto_percentual/100*l:e.desconto_valor||0,{data:u,error:f}=await r.from("ordens_servico").insert([{...e,numero:o,total_servicos:n,total_produtos:i,total_horas:c,total_itens:s,desconto_valor:d,valor_total:l-d}]).select().single();if(f)throw Error(f.message);if(a.length>0){let e=a.map((e,a)=>({...e,os_id:u.id,ordem:a})),{error:t}=await r.from("os_servicos").insert(e);if(t)throw Error(t.message)}if(t.length>0){let e=t.map((e,a)=>({...e,os_id:u.id,ordem:a})),{error:a}=await r.from("os_produtos").insert(e);if(a)throw Error(a.message)}return u}async function eR(e,a,t,o){let n=t.reduce((e,a)=>e+(a.valor_total||0),0),i=o.reduce((e,a)=>e+(a.valor_total||0),0),c=t.reduce((e,a)=>e+(a.quantidade||0),0),s=o.reduce((e,a)=>e+(a.quantidade||0),0),l=n+i,d=a.desconto_percentual?a.desconto_percentual/100*l:a.desconto_valor||0,{data:u,error:f}=await r.from("ordens_servico").update({...a,total_servicos:n,total_produtos:i,total_horas:c,total_itens:s,desconto_valor:d,valor_total:l-d,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(f)throw Error(f.message);if(await r.from("os_servicos").delete().eq("os_id",e),await r.from("os_produtos").delete().eq("os_id",e),t.length>0){let a=t.map((a,t)=>({descricao:a.descricao,quantidade:a.quantidade,valor_unitario:a.valor_unitario,valor_total:a.valor_total,os_id:e,ordem:t}));await r.from("os_servicos").insert(a)}if(o.length>0){let a=o.map((a,t)=>({produto_id:a.produto_id,codigo:a.codigo,descricao:a.descricao,unidade:a.unidade,ncm:a.ncm,quantidade:a.quantidade,valor_unitario:a.valor_unitario,valor_total:a.valor_total,os_id:e,ordem:t}));await r.from("os_produtos").insert(a)}return u}async function ej(e){let{error:a}=await r.from("ordens_servico").delete().eq("id",e);if(a)throw Error(a.message)}async function ez(e,a){let t;if("aprovado"===a){var o;let n=await eT(e);if(!n)throw Error("Ordem de servi\xe7o n\xe3o encontrada");if(n.venda_id)throw Error("Este or\xe7amento j\xe1 possui uma venda vinculada");let i=[],c=0;if(n.servicos&&n.servicos.length>0&&n.servicos.forEach(e=>{i.push({produto_id:null,tipo:"servico",descricao:e.descricao,quantidade:e.quantidade,valor_unitario:e.valor_unitario,valor_desconto:0,valor_total:e.valor_total,custo_unitario:0})}),n.produtos&&n.produtos.length>0)for(let e of n.produtos){let a=0;if(e.produto_id){let{data:t}=await r.from("produtos").select("valor_custo, custo_medio").eq("id",e.produto_id).single();t&&(a=t.custo_medio||t.valor_custo||0)}c+=a*e.quantidade,i.push({produto_id:e.produto_id,tipo:"produto",descricao:e.descricao,quantidade:e.quantidade,valor_unitario:e.valor_unitario,valor_desconto:0,valor_total:e.valor_total,custo_unitario:a})}let s=n.valor_total-c,l=n.valor_total>0?s/n.valor_total*100:0,{data:d}=await r.from("vendas").select("numero").order("id",{ascending:!1}).limit(1),u=String(((null==d?void 0:null===(o=d[0])||void 0===o?void 0:o.numero)?parseInt(d[0].numero):0)+1).padStart(6,"0"),f={numero:u,cliente_id:n.cliente_id,data_venda:new Date().toISOString().split("T")[0],valor_produtos:n.total_produtos,valor_servicos:n.total_servicos,valor_desconto:n.desconto_valor,valor_frete:0,valor_total:n.valor_total,custo_total:c,lucro_bruto:s,margem_lucro:l,nota_fiscal_emitida:!1,valor_impostos:0,status:"concluida",observacoes:"Venda gerada automaticamente do Or\xe7amento (OS) #".concat(n.numero)},m=await ex(f,i);t=m.id,await $({tipo:"receita",valor:n.valor_total,data_lancamento:new Date().toISOString().split("T")[0],descricao:"Venda #".concat(u," (OS #").concat(n.numero,")"),cliente_id:n.cliente_id||void 0,venda_id:m.id,forma_pagamento:"dinheiro",conciliado:!1});let{error:_}=await r.from("ordens_servico").update({status:a,venda_id:m.id,updated_at:new Date().toISOString()}).eq("id",e);if(_)throw Error(_.message)}else{let{error:t}=await r.from("ordens_servico").update({status:a,updated_at:new Date().toISOString()}).eq("id",e);if(t)throw Error(t.message)}return{venda_id:t}}},22169:function(e,a,t){t.d(a,{K3:function(){return m},T3:function(){return s},Wi:function(){return d},Wt:function(){return u},cn:function(){return r},d5:function(){return l},fj:function(){return f},p6:function(){return c},xG:function(){return i},zm:function(){return p}});var o=t(57042),n=t(74769);function r(){for(var e=arguments.length,a=Array(e),t=0;t<e;t++)a[t]=arguments[t];return(0,n.m6)((0,o.W)(a))}function i(e){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL",minimumFractionDigits:2,maximumFractionDigits:2}).format(e)}function c(e){if(!e)return"-";let a=new Date(e);return isNaN(a.getTime())?"-":a.toLocaleDateString("pt-BR")}function s(e){return"".concat(e.toFixed(1),"%")}function l(e,a){return a&&0!==a?e/a*100:0}function d(e){return("string"==typeof e?parseFloat(e)||0:e).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function u(e){return e&&parseFloat(e.replace(/\./g,"").replace(",","."))||0}function f(e){let a=e.replace(/\D/g,"");return a?(parseInt(a)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function m(e){return"".concat("/controle-orcamentos").concat(e)}let _=["UN","PC","KG","G","L","ML","M","CM","M2","M3","CX","PAR","SC","FD","PCT","RL","TON","DZ","CT","BD","JG","KIT","AMPOLA","UNID","PECA","METRO","LITRO","QUILO","CAIXA","SACO","FARDO","PACOTE","ROLO","DUZIA","CARTELA","BALDE","JOGO"],g={UNID:"UN",UNIDADE:"UN",UNIDADES:"UN",PECA:"PC",PEÇA:"PC",PECAS:"PC",PEÇAS:"PC",METRO:"M",METROS:"M",LITRO:"L",LITROS:"L",QUILO:"KG",QUILOS:"KG",QUILOGRAMA:"KG",QUILOGRAMAS:"KG",GRAMA:"G",GRAMAS:"G",MILILITRO:"ML",MILILITROS:"ML",CENTIMETRO:"CM",CENTIMETROS:"CM",CENTÍMETRO:"CM",CENTÍMETROS:"CM",CAIXA:"CX",CAIXAS:"CX",SACO:"SC",SACOS:"SC",FARDO:"FD",FARDOS:"FD",PACOTE:"PCT",PACOTES:"PCT",ROLO:"RL",ROLOS:"RL",TONELADA:"TON",TONELADAS:"TON",DUZIA:"DZ",DÚZIA:"DZ",DUZIAS:"DZ",CARTELA:"CT",CARTELAS:"CT",BALDE:"BD",BALDES:"BD",JOGO:"JG",JOGOS:"JG"};function p(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"UN";if(null==e)return a;if("number"==typeof e)return console.warn("[normalizeUnidade] Valor num\xe9rico recebido: ".concat(e,". Usando default: ").concat(a)),a;let t=String(e).trim().toUpperCase();if(!t)return a;if(/^\d+$/.test(t))return console.warn('[normalizeUnidade] String num\xe9rica recebida: "'.concat(e,'". Usando default: ').concat(a)),a;if(g[t])return g[t];if(_.includes(t))return t;let o=t.split(/\s+/)[0];return _.includes(o)?o:g[o]?g[o]:(console.warn('[normalizeUnidade] Unidade desconhecida: "'.concat(e,'". Usando default: ').concat(a)),a)}}}]);